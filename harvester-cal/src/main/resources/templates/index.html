<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Harvester Calculator - SR Harvester Company</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" th:href="@{/css/style.css}" />
</head>
<body>
<nav class="navbar navbar-dark bg-primary">
  <div class="container-fluid">
    <span class="navbar-brand mb-0 h1">
      <img src="/static/images/logo.svg" width="40" height="40" alt="logo" class="me-2" />
      SR Harvester Company - Harvester Calculator
    </span>
  </div>
</nav>

<div class="container my-4">
  <div class="card shadow-sm">
    <div class="card-body">
      <h4 class="card-title">Create / Edit Bill</h4>
      <form th:action="@{/save}" th:object="${bill}" method="post" id="billForm">
        <input type="hidden" th:field="*{id}" />
        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label">Date</label>
            <input type="date" class="form-control" th:field="*{date}" />
          </div>
          <div class="col-md-4">
            <label class="form-label">Customer Name</label>
            <input type="text" class="form-control" th:field="*{customerName}" required/>
          </div>
          <div class="col-md-4">
            <label class="form-label">Mobile</label>
            <input type="text" class="form-control" th:field="*{mobile}" />
          </div>

          <div class="col-md-3">
            <label class="form-label">Start Time (hh:mm)</label>
            <input type="text" class="form-control" id="startTime" th:value="${bill.startTime}" placeholder="09:30 AM" />
            <input type="hidden" th:field="*{startTime}" id="hiddenStart"/>
          </div>
          <div class="col-md-3">
            <label class="form-label">Stop Time (hh:mm)</label>
            <input type="text" class="form-control" id="stopTime" th:value="${bill.stopTime}" placeholder="11:15 AM" />
            <input type="hidden" th:field="*{stopTime}" id="hiddenStop"/>
          </div>

          <div class="col-md-3">
            <label class="form-label">Hourly Rate (₹)</label>
            <input type="number" step="0.01" class="form-control" th:field="*{hourlyRate}" id="hourlyRate"/>
          </div>
          <div class="col-md-3">
            <label class="form-label">Total Hours</label>
            <input type="number" step="0.01" class="form-control" th:field="*{totalHours}" id="totalHours"/>
          </div>

          <div class="col-md-6">
            <label class="form-label">Total Bill (₹)</label>
            <input type="number" step="0.01" class="form-control" th:field="*{totalBill}" id="totalBill"/>
          </div>

        </div>

        <div class="mt-3">
          <button type="button" class="btn btn-primary" onclick="compute()">Calculate</button>
          <button type="submit" class="btn btn-success">Save</button>
          <a href="/list" class="btn btn-secondary">View Saved Bills</a>
          <button type="button" class="btn btn-outline-danger" onclick="resetForm()">Reset</button>
        </div>
      </form>
      <small class="text-muted mt-2 d-block">Examples for time: `09:30 AM`, `12:05 PM`</small>
    </div>
  </div>
</div>

<script>
  function parseToMinutes(t){
    if(!t) return null;
    t = t.trim();
    const parts = t.split(' ');
    if(parts.length < 2) return null;
    const time = parts[0];
    const ampm = parts[1].toUpperCase();
    const hm = time.split(':');
    if(hm.length < 2) return null;
    let h = parseInt(hm[0],10);
    const m = parseInt(hm[1],10);
    if(ampm === 'AM' && h===12) h = 0;
    if(ampm === 'PM' && h<12) h += 12;
    return h*60 + m;
  }

  function compute(){
    const s = document.getElementById('startTime').value;
    const e = document.getElementById('stopTime').value;
    const rate = parseFloat(document.getElementById('hourlyRate').value) || 0;

    document.getElementById('hiddenStart').value = s;
    document.getElementById('hiddenStop').value = e;

    const sm = parseToMinutes(s);
    const em = parseToMinutes(e);
    let durationHours = 0;
    if(sm != null && em != null){
      let mins = em - sm;
      if(mins < 0) mins += 24*60;
      durationHours = +(mins/60).toFixed(2);
      document.getElementById('totalHours').value = durationHours;
      document.getElementById('totalBill').value = (durationHours * rate).toFixed(2);
    } else {
      alert('Please provide start and stop time in format HH:MM AM/PM (e.g., 09:30 AM).');
    }
  }

  function resetForm(){
    document.getElementById('billForm').reset();
    document.getElementById('hourlyRate').value = 3000.0;
  }

  window.onload = function(){
    if(!document.getElementById('hourlyRate').value) document.getElementById('hourlyRate').value = 3000.0;
  }
</script>

</body>
</html>
